name: Laravel CI/CD - Management Pinetmart (Zero Downtime + Backup + Cleanup)

on:
  push:
    branches:
      - main
      - develop

jobs:
  # =============================
  # 1Ô∏è‚É£ Continuous Integration (CI)
  # =============================
  ci:
    name: Laravel CI
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:8
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: management
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping -h 127.0.0.1 -uroot -proot"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Setup PHP 8.2
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, bcmath, pdo_mysql, intl

      - name: Install Composer Dependencies
        run: composer install --no-progress --prefer-dist --optimize-autoloader

      - name: Copy CI Environment
        run: cp .env.ci .env || echo "‚ö†Ô∏è CI env file tidak ada, dilewati"

      - name: Generate App Key
        run: php artisan key:generate --ansi

      - name: Skip Migrations & Tests
        run: echo "‚úÖ CI jalan, tapi migrations & tests dilewati"


  # =============================
  # 2Ô∏è‚É£ Continuous Deployment (CD)
  # =============================
  cd:
    name: Deploy Laravel Zero Downtime (Hostinger)
    runs-on: ubuntu-latest
    needs: ci

    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.HOSTINGER_HOST }}
          username: ${{ secrets.HOSTINGER_USER }}
          key: ${{ secrets.HOSTINGER_SSH_KEY }}
          port: ${{ secrets.HOSTINGER_PORT }}
          script: |
            set -e
            echo "üöÄ Zero Downtime Deploy Laravel..."

            # -------------------------------
            # 1. Konfigurasi path & nama release
            # -------------------------------
            APP_DIR=~/domains/management-pinetmart.srf-group.com
            WEB_ROOT=$APP_DIR/public_html
            RELEASES_DIR=$APP_DIR/releases
            RELEASE_NAME=$(date +%Y%m%d_%H%M%S)
            NEW_RELEASE=$RELEASES_DIR/$RELEASE_NAME
            BACKUP_FOLDER=$APP_DIR/backup_$RELEASE_NAME

            # folders upload yang harus disimpan (shared)
            UPLOAD_FOLDERS="ktp profile selfie verifikasi"

            # -------------------------------
            # 2. Backup sebelum deploy
            # -------------------------------
            echo "üíæ Backup storage & public_html"
            mkdir -p "$BACKUP_FOLDER"
            cp -r "$APP_DIR/storage" "$BACKUP_FOLDER/storage" || echo "‚ö†Ô∏è Storage kosong"
            cp -r "$WEB_ROOT" "$BACKUP_FOLDER/public" || echo "‚ö†Ô∏è Public kosong"

            # -------------------------------
            # 3. Siapkan shared upload folder (jika belum ada)
            #    dan migrasi file upload yang saat ini ada di public_html
            #    ke shared agar tidak hilang.
            # -------------------------------
            echo "üìÅ Menyiapkan folder shared untuk uploads"
            mkdir -p "$APP_DIR/shared/uploads"
            for f in $UPLOAD_FOLDERS; do
              mkdir -p "$APP_DIR/shared/uploads/$f"
            done

            echo "üì¶ Migrasi file upload yang masih ada di $WEB_ROOT ke folder shared (jika ada)"
            for f in $UPLOAD_FOLDERS; do
              SRC="$WEB_ROOT/assets/images/$f"
              DST="$APP_DIR/shared/uploads/$f"
              if [ -d "$SRC" ] && [ ! -L "$SRC" ]; then
                echo "  - Menyalin isi $SRC -> $DST"
                rsync -a --ignore-existing "$SRC/" "$DST/" || true
              fi
            done

            # pastikan permission di shared uploads agar webserver bisa menulis
            chmod -R ug+rwX "$APP_DIR/shared/uploads" || true

            # -------------------------------
            # 4. Buat release baru (git clone)
            # -------------------------------
            echo "üì• Clone repository ke release baru: $NEW_RELEASE"
            mkdir -p "$NEW_RELEASE"
            git clone --branch main https://github.com/indopinetmart/management_apk.git "$NEW_RELEASE"

            # -------------------------------
            # 5. Shared resource (env & storage)
            # -------------------------------
            echo "üìÑ Gunakan .env & storage lokal (shared)"
            ln -sfn "$APP_DIR/.env" "$NEW_RELEASE/.env"
            ln -sfn "$APP_DIR/storage" "$NEW_RELEASE/storage"

            # -------------------------------
            # 6. Buat symlink folder uploads di dalam release ke shared
            #    (ganti folder repo dengan symlink ke shared uploads)
            # -------------------------------
            echo "üîó Membuat symlink uploads di dalam release -> shared/uploads"
            mkdir -p "$NEW_RELEASE/public/assets/images"
            for f in $UPLOAD_FOLDERS; do
              # hapus folder repo (jika ada), lalu link ke shared
              if [ -e "$NEW_RELEASE/public/assets/images/$f" ] || [ -L "$NEW_RELEASE/public/assets/images/$f" ]; then
                rm -rf "$NEW_RELEASE/public/assets/images/$f"
              fi
              ln -sfn "$APP_DIR/shared/uploads/$f" "$NEW_RELEASE/public/assets/images/$f"
            done

            # -------------------------------
            # 7. Install dependencies + migrate + cache
            # -------------------------------
            echo "üì¶ Install composer, migrate, cache"
            cd "$NEW_RELEASE"
            composer install --no-dev --no-interaction --prefer-dist --optimize-autoloader --ansi
            php artisan migrate --force
            # buat storage:link juga (aman untuk penggunaan disk 'public' jika dipakai)
            php artisan storage:link || true
            php artisan config:cache
            php artisan route:cache
            php artisan view:cache

            # -------------------------------
            # 8. Update symlink 'current' ke release baru
            # -------------------------------
            echo "üîÅ Update symlink current -> $NEW_RELEASE"
            ln -sfn "$NEW_RELEASE" "$APP_DIR/current"

            # -------------------------------
            # 9. Sync (rsync) public content ke webroot
            #    (rsync akan menyalin symlink yang sudah kita buat)
            # -------------------------------
            echo "‚¨ÜÔ∏è Rsync current/public -> $WEB_ROOT (dengan delete untuk membersihkan file lama)"
            rsync -a --delete "$APP_DIR/current/public/" "$WEB_ROOT/"

            # -------------------------------
            # 10. Pastikan index.php menunjuk ke current (jika diperlukan)
            # -------------------------------
            echo "üîß Memastikan index.php menunjuk ke current/"
            sed -i "s|../vendor/autoload.php|../current/vendor/autoload.php|" "$WEB_ROOT/index.php" || true
            sed -i "s|../bootstrap/app.php|../current/bootstrap/app.php|" "$WEB_ROOT/index.php" || true

            # -------------------------------
            # 11. Supaya aman: pastikan symlink di webroot mengarah ke shared
            #     (jika rsync mengganti symlink, kita set ulang)
            # -------------------------------
            echo "üîÅ Menegaskan ulang symlink uploads di webroot -> shared/uploads"
            for f in $UPLOAD_FOLDERS; do
              TARGET="$APP_DIR/shared/uploads/$f"
              DEST="$WEB_ROOT/assets/images/$f"
              # hapus jika ada (folder biasa atau symlink), lalu buat symlink baru
              if [ -e "$DEST" ] || [ -L "$DEST" ]; then
                rm -rf "$DEST"
              fi
              ln -sfn "$TARGET" "$DEST"
            done

            # -------------------------------
            # 12. Set permission
            # -------------------------------
            echo "üîê Set permission untuk storage, uploads, dan cache"
            chmod -R ug+rwx "$APP_DIR/shared/uploads" "$NEW_RELEASE/storage" "$NEW_RELEASE/bootstrap/cache" || true
            chmod -R 755 "$WEB_ROOT" || true
            chmod 644 "$APP_DIR/.env" "$WEB_ROOT/index.php" "$WEB_ROOT/.htaccess" || true

            # -------------------------------
            # 13. Cleanup file sensitif dari release
            # -------------------------------
            echo "üßπ Cleanup file sensitif di release"
            rm -rf "$NEW_RELEASE/.git"
            rm -f "$NEW_RELEASE/phpunit.xml" "$NEW_RELEASE/README.md" "$NEW_RELEASE/LICENSE" || true

            # -------------------------------
            # 14. Cleanup release lama (keep 5 terakhir)
            # -------------------------------
            echo "üßæ Hapus release lama, simpan 5 terakhir"
            cd "$RELEASES_DIR"
            ls -1t | tail -n +6 | xargs rm -rf || true

            # -------------------------------
            # 15. Cleanup backup lama (keep 3 hari terakhir)
            # -------------------------------
            echo "üóëÔ∏è  Hapus backup lebih dari 3 hari"
            find "$APP_DIR" -maxdepth 1 -type d -name "backup_*" -mtime +3 -exec rm -rf {} \;

            echo "‚úÖ Deployment selesai tanpa downtime!"
            echo "üìÇ Release aktif: $RELEASE_NAME"
            echo "üíæ Backup: $BACKUP_FOLDER"
