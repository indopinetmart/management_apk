name: Laravel CI/CD - Management Pinetmart Subdomain (Production Secure + Public Backup)

on:
  push:
    branches:
      - main
      - develop

jobs:
  # =============================
  # 1Ô∏è‚É£ Continuous Integration (CI)
  # =============================
  ci:
    name: Laravel CI
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:8
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: management
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping -h 127.0.0.1 -uroot -proot"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Setup PHP 8.2
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, bcmath, pdo_mysql, intl

      - name: Install Composer Dependencies
        run: composer install --no-progress --prefer-dist --optimize-autoloader

      - name: Copy CI Environment
        run: cp .env.ci .env || echo "CI env file not found, skipping"

      - name: Generate App Key
        run: php artisan key:generate --ansi

      - name: Skip Migrations & Tests
        run: echo "Migrations & tests dilewati di CI"

  # =============================
  # 2Ô∏è‚É£ Continuous Deployment (CD) Production Secure
  # =============================
  cd:
    name: Deploy Laravel to Hostinger (Secure Production + Public Backup)
    runs-on: ubuntu-latest
    needs: ci

    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.HOSTINGER_HOST }}
          username: ${{ secrets.HOSTINGER_USER }}
          key: ${{ secrets.HOSTINGER_SSH_KEY }}
          port: ${{ secrets.HOSTINGER_PORT }}
          script: |
            set -e
            echo "üöÄ Mulai deployment Laravel (Secure Production + Public Backup)..."

            # -------------------------------
            # 1. Tentukan folder target & backup
            # -------------------------------
            WEB_ROOT=~/domains/management-pinetmart.srf-group.com/public_html
            LARAVEL_DIR=~/domains/management-pinetmart.srf-group.com/management_apk
            BACKUP_FOLDER=~/domains/management-pinetmart.srf-group.com/backup_$(date +%Y%m%d_%H%M%S)

            mkdir -p $BACKUP_FOLDER

            # -------------------------------
            # 2. Backup storage Laravel + public_html
            # -------------------------------
            echo "üíæ Backup storage Laravel"
            mkdir -p $LARAVEL_DIR/storage $LARAVEL_DIR/bootstrap/cache
            cp -r $LARAVEL_DIR/storage $BACKUP_FOLDER/storage || echo "‚ö†Ô∏è Backup storage Laravel gagal, folder kosong"

            echo "üíæ Backup storage publik (public_html/uploads atau storage publik)"
            mkdir -p $BACKUP_FOLDER/public
            [ -d "$WEB_ROOT/storage" ] && cp -r $WEB_ROOT/storage $BACKUP_FOLDER/public/storage
            [ -d "$WEB_ROOT/uploads" ] && cp -r $WEB_ROOT/uploads $BACKUP_FOLDER/public/uploads

            # -------------------------------
            # 3. Clone / update repo Laravel dengan aman
            # -------------------------------
            mkdir -p $LARAVEL_DIR
            cd $LARAVEL_DIR

            if [ -z "$(ls -A $LARAVEL_DIR)" ]; then
              echo "üì• Clone repo Laravel"
              git clone https://${GITHUB_PAT}@github.com/indopinetmart/management_apk.git .
            else
              if [ ! -d ".git" ]; then
                echo "‚ö†Ô∏è Folder ada tapi bukan repo git, hapus semua dan clone"
                rm -rf $LARAVEL_DIR/*
                git clone https://${GITHUB_PAT}@github.com/indopinetmart/management_apk.git .
              else
                echo "üîÑ Update repo Laravel"
                git fetch origin main
                git reset --hard origin/main
              fi
            fi

            # -------------------------------
            # 4. Upload .env dari GitHub Secrets
            # -------------------------------
            echo "üìÑ Menyimpan .env production dari secrets"
            echo "${{ secrets.ENV_PRODUCTION }}" > $LARAVEL_DIR/.env

            # -------------------------------
            # 5. Aktifkan maintenance mode
            # -------------------------------
            echo "üõ†Ô∏è Aktifkan maintenance mode"
            php artisan down || echo "‚ö†Ô∏è Gagal aktifkan maintenance mode"

            # -------------------------------
            # 6. Install Composer dependencies production
            # -------------------------------
            echo "üîß Install composer dependencies (production)"
            composer install --no-dev --no-interaction --prefer-dist --optimize-autoloader

            # -------------------------------
            # 7. Jalankan migrate & cache
            # -------------------------------
            echo "üóÑÔ∏è Jalankan migrate"
            php artisan migrate --force

            echo "‚ö° Cache config, route, view"
            php artisan config:cache
            php artisan route:cache
            php artisan view:cache

            # -------------------------------
            # 8. Duplicate index.php & .htaccess ke web root
            # -------------------------------
            echo "üìÑ Duplicate index.php & .htaccess ke public_html"
            cp $LARAVEL_DIR/public/index.php $WEB_ROOT/index.php
            cp $LARAVEL_DIR/public/.htaccess $WEB_ROOT/.htaccess

            sed -i "s|../vendor/autoload.php|../management_apk/vendor/autoload.php|" $WEB_ROOT/index.php
            sed -i "s|../bootstrap/app.php|../management_apk/bootstrap/app.php|" $WEB_ROOT/index.php

            # -------------------------------
            # 9. Set permission folder penting
            # -------------------------------
            echo "üîí Set permission storage, bootstrap/cache, public_html"
            chmod -R 755 $LARAVEL_DIR/storage $LARAVEL_DIR/bootstrap/cache $WEB_ROOT
            [ -f "$LARAVEL_DIR/.env" ] && chmod 644 $LARAVEL_DIR/.env
            chmod 644 $LARAVEL_DIR/artisan $WEB_ROOT/index.php $WEB_ROOT/.htaccess

            # -------------------------------
            # 10. Hapus file sensitif (opsional)
            # -------------------------------
            echo "üóëÔ∏è Hapus file sensitif dari Laravel folder (opsional)"
            rm -rf $LARAVEL_DIR/.git
            rm -f $LARAVEL_DIR/phpunit.xml $LARAVEL_DIR/README.md $LARAVEL_DIR/LICENSE

            # -------------------------------
            # 11. Nonaktifkan maintenance mode
            # -------------------------------
            echo "‚úÖ Nonaktifkan maintenance mode"
            php artisan up || echo "‚ö†Ô∏è Gagal disable maintenance mode"

            echo "‚úÖ Deployment selesai!"
            echo "üíæ Backup storage Laravel: $BACKUP_FOLDER/storage"
            echo "üíæ Backup storage publik: $BACKUP_FOLDER/public"
            echo "üîí public_html sudah aman, Laravel project di luar web root"
