name: Laravel CI/CD - Management Pinetmart Subdomain (Production Secure)

on:
  push:
    branches:
      - main
      - develop

jobs:
  ci:
    name: Laravel CI
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:8
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: management
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping -h 127.0.0.1 -uroot -proot"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Setup PHP 8.2
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, bcmath, pdo_mysql, intl

      - name: Install Composer Dependencies
        run: composer install --no-progress --prefer-dist --optimize-autoloader

      - name: Copy CI Environment
        run: cp .env.ci .env || echo "CI env file not found, skipping"

      - name: Generate App Key
        run: php artisan key:generate --ansi

      - name: Skip Migrations & Tests
        run: echo "Migrations & tests dilewati di CI"

  cd:
    name: Deploy Laravel to Hostinger (Secure Production)
    runs-on: ubuntu-latest
    needs: ci

    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.HOSTINGER_HOST }}
          username: ${{ secrets.HOSTINGER_USER }}
          key: ${{ secrets.HOSTINGER_SSH_KEY }}
          port: ${{ secrets.HOSTINGER_PORT }}
          script: |
            set -e
            echo "ğŸš€ Mulai deployment Laravel (Secure Production)..."

            # -------------------------------
            # 1. Folder target & backup
            # -------------------------------
            TARGET=~/domains/management-pinetmart.srf-group.com/public_html
            BACKUP_FOLDER=~/domains/management-pinetmart.srf-group.com/backup_$(date +%Y%m%d_%H%M%S)
            DB_BACKUP=~/domains/management-pinetmart.srf-group.com/db_backup_$(date +%Y%m%d_%H%M%S).sql

            # -------------------------------
            # 2. Backup DB & storage
            # -------------------------------
            echo "ğŸ’¾ Backup database"
            mysqldump -u ${{ secrets.DB_USER }} -p${{ secrets.DB_PASS }} ${{ secrets.DB_NAME }} > $DB_BACKUP || echo "âš ï¸ DB backup gagal"

            echo "ğŸ’¾ Backup storage"
            mkdir -p $BACKUP_FOLDER/storage
            cp -r $TARGET/storage/* $BACKUP_FOLDER/storage/

            # -------------------------------
            # 3. Aktifkan maintenance mode
            # -------------------------------
            echo "ğŸ› ï¸ Aktifkan maintenance mode"
            php $TARGET/artisan down || echo "âš ï¸ Gagal aktifkan maintenance mode"

            # -------------------------------
            # 4. Clone/update repo Laravel
            # -------------------------------
            cd $TARGET
            if [ ! -d ".git" ]; then
              echo "ğŸ“¥ Clone repo Laravel"
              git clone https://${GITHUB_PAT}@github.com/indopinetmart/management_apk.git .
            else
              echo "ğŸ”„ Update repo Laravel"
              git fetch origin main
              git reset --hard origin/main
            fi

            # -------------------------------
            # 5. Copy .env production jika belum ada
            # -------------------------------
            if [ ! -f ".env" ]; then
              echo "âš ï¸ .env production tidak ada. Harap upload manual!"
            fi

            # -------------------------------
            # 6. Install Composer dependencies production
            # -------------------------------
            echo "ğŸ”§ Install composer dependencies (production)"
            composer install --no-dev --no-interaction --prefer-dist --optimize-autoloader

            # -------------------------------
            # 7. Run migrations & optional seed
            # -------------------------------
            echo "ğŸ—„ï¸ Jalankan migrate"
            php artisan migrate --force
            # php artisan db:seed --class=SeederName --force  # opsional

            # -------------------------------
            # 8. Cache Laravel
            # -------------------------------
            echo "âš¡ Cache config, route, view"
            php artisan config:cache
            php artisan route:cache
            php artisan view:cache

            # -------------------------------
            # 9. Set permission
            # -------------------------------
            echo "ğŸ”’ Set permission storage, bootstrap/cache, public"
            chmod -R 755 storage bootstrap/cache public
            chmod 644 .env artisan

            # -------------------------------
            # 10. Hapus file sensitif dari public_html
            # -------------------------------
            echo "ğŸ—‘ï¸ Hapus file sensitif dari public_html"
            rm -rf .git
            rm -f composer.json composer.lock artisan phpunit.xml README.md LICENSE

            # -------------------------------
            # 11. Nonaktifkan maintenance mode
            # -------------------------------
            echo "âœ… Nonaktifkan maintenance mode"
            php artisan up || echo "âš ï¸ Gagal disable maintenance mode"

            echo "âœ… Deployment selesai!"
            echo "ğŸ’¾ Backup database: $DB_BACKUP"
            echo "ğŸ’¾ Backup storage: $BACKUP_FOLDER/storage"
            echo "ğŸ”’ public_html sudah aman, file sensitif dihapus"
